#!/bin/bash

# Check if one argument is provided
if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <excel_file>"
    exit 1
fi

# Check if csvkit is installed
if ! command -v in2csv &> /dev/null; then
    echo "csvkit is not installed. Please install it first."
    echo "You can install it using pip: pip install csvkit"
    exit 1
fi

# Convert the Excel file to a temporary CSV file
excel_file="$1"
temp_csv=$(mktemp)
in2csv "$excel_file" > "$temp_csv"

# Function to compare two CSV files and save the differences
compare_csv_files() {
    local file1="$1"
    local file2="$2"
    local output_file="$3"

    local file1_sorted=$(mktemp)
    local file2_sorted=$(mktemp)

    awk 'NR > 1' "$file1" | sort > "$file1_sorted"
    awk 'NR > 1' "$file2" | sort > "$file2_sorted"

    # Compare the sorted files and store the differences in a variable
    differences=$(diff -u "$file1_sorted" "$file2_sorted")

    # If there are differences, save them to the output file
    if [ -n "$differences" ]; then
        echo "$differences" > "$output_file"
        echo "Differences saved to $output_file"
    else
        echo "No differences found"
    fi

    rm "$file1_sorted"
    rm "$file2_sorted"
}

# Read the temporary CSV file line by line and perform comparisons
while IFS=',' read -r file1 file2 output_file; do
    compare_csv_files "$file1" "$file2" "$output_file"
done < <(tail -n +2 "$temp_csv")

# Clean up the temporary CSV file
rm "$temp_csv"
